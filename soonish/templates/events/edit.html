{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto p-4">
    <div class="bg-white dark:bg-dark-card shadow-lg overflow-hidden sm:rounded-lg border border-gray-200 dark:border-gray-700">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Edit Event</h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Update your event details.</p>
        </div>
        <div class="px-4 py-5 sm:p-6 space-y-6">
            <form id="event-form" class="space-y-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                    <input type="text" name="title" id="title" required
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea name="description" id="description" rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500"></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="target_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" name="target_date" id="target_date" required
                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                    </div>
                    <div>
                        <label for="target_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Time (optional, defaults to noon)
                        </label>
                        <input type="time" name="target_time" id="target_time"
                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" name="is_recurring" id="is_recurring"
                               class="h-4 w-4 text-primary dark:text-primary-dark focus:ring-primary dark:focus:ring-primary-dark border-gray-300 dark:border-gray-600 rounded">
                        <label for="is_recurring" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Recurring Event
                        </label>
                    </div>
                    
                    <div id="recurrence_options" class="hidden">
                        <label for="recurrence_pattern" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Recurrence Pattern
                        </label>
                        <select name="recurrence_pattern" id="recurrence_pattern"
                                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="window.location.href='/'"
                            class="inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-lighter hover:bg-gray-50 dark:hover:bg-dark-lightest focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Cancel
                    </button>
                    <button type="submit"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary dark:bg-primary-dark hover:bg-primary-dark dark:hover:bg-primary-darker focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Update Event
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Get event ID from URL - now correctly parsing the ID from /events/{id}/edit
    const eventId = window.location.pathname.split('/')[2]
    console.log('Event ID:', eventId)  // Debug log
    
    // Fetch event data
    fetch(`/api/v1/events/${eventId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`)
            }
            return response.json()
        })
        .then(event => {
            console.log('Event data:', event)  // Debug log
            // Fill form with event data
            document.getElementById('title').value = event.title
            document.getElementById('description').value = event.description || ''
            
            // Format date and time using timezone utils
            const localDateTime = timezoneUtils.utcToLocalInputs(event.target_date);
            document.getElementById('target_date').value = localDateTime.date;
            document.getElementById('target_time').value = localDateTime.time;

            // Set recurring options
            const isRecurringCheckbox = document.getElementById('is_recurring');
            const recurrenceOptions = document.getElementById('recurrence_options');
            isRecurringCheckbox.checked = event.is_recurring;
            recurrenceOptions.classList.toggle('hidden', !event.is_recurring);
            
            if (event.is_recurring && event.recurrence_pattern) {
                document.getElementById('recurrence_pattern').value = event.recurrence_pattern;
            }

            // Handle recurring checkbox changes
            isRecurringCheckbox.addEventListener('change', (e) => {
                recurrenceOptions.classList.toggle('hidden', !e.target.checked);
            });
        })
        .catch(error => {
            console.error('Error fetching event:', error)
            alert('Failed to load event details: ' + error.message)
            // Redirect to dashboard on error
            window.location.href = '/'
        })
    
    // Handle form submission
    document.getElementById('event-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const formData = new FormData(e.target)
        const date = formData.get('target_date');
        const time = formData.get('target_time') || '12:00';
        const target_date = timezoneUtils.localToUTC(date, time);
        
        const isRecurring = formData.get('is_recurring') === 'on';
        const data = {
            title: formData.get('title'),
            description: formData.get('description') || null,
            target_date: target_date,
            is_recurring: isRecurring,
            notify_before: null,
            recurrence_pattern: isRecurring ? formData.get('recurrence_pattern') : null
        }
        
        console.log('Submitting data:', data)  // Debug log
        
        try {
            const response = await fetch(`/api/v1/events/${eventId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            
            if (!response.ok) {
                const errorData = await response.json()
                throw new Error(errorData.detail || 'Failed to update event')
            }
            
            window.location.href = '/'
        } catch (error) {
            console.error('Error updating event:', error)
            alert('Failed to update event: ' + error.message)
        }
    })
})
</script>
{% endblock %}
