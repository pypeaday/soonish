{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto p-4">
    <div class="bg-white dark:bg-dark-card shadow-lg overflow-hidden sm:rounded-lg border border-gray-200 dark:border-gray-700">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ title | default('Create New Event') }}</h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Add a new event to your countdown dashboard.</p>
        </div>
        <div class="px-4 py-5 sm:p-6 space-y-6">
            <form id="event-form" class="space-y-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                    <input type="text" name="title" id="title" required
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea name="description" id="description" rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500"></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="target_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" name="target_date" id="target_date" required
                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                    </div>
                    <div>
                        <label for="target_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Time (optional, defaults to noon)
                        </label>
                        <input type="time" name="target_time" id="target_time"
                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Category Selection -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <div class="mt-1 flex items-center space-x-2">
                            <select name="category_id" id="category_id"
                                    class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                                <option value="">No Category</option>
                            </select>
                            <button type="button" id="new-category-btn"
                                    class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-lighter hover:bg-gray-50 dark:hover:bg-dark-lightest focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                New
                            </button>
                        </div>
                    </div>

                    <!-- Recurring Event -->
                    <div class="flex items-center">
                        <input type="checkbox" name="is_recurring" id="is_recurring"
                               class="h-4 w-4 text-primary dark:text-primary-dark focus:ring-primary dark:focus:ring-primary-dark border-gray-300 dark:border-gray-600 rounded">
                        <label for="is_recurring" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Recurring Event
                        </label>
                    </div>
                    
                    <div id="recurrence_options" class="hidden">
                        <label for="recurrence_pattern" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Recurrence Pattern
                        </label>
                        <select name="recurrence_pattern" id="recurrence_pattern"
                                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <a href="/" class="inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-lighter hover:bg-gray-50 dark:hover:bg-dark-lightest focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Cancel
                    </a>
                    <button type="submit"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary dark:bg-primary-dark hover:bg-primary-dark dark:hover:bg-primary-darker focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Category Modal -->
<div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-80"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">New Category</h3>
            </div>
            <form id="category-form" class="p-6 space-y-4">
                <div>
                    <label for="category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="category-name" name="name" required
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark sm:text-sm dark:bg-dark-lighter dark:text-gray-100">
                </div>
                <div>
                    <label for="category-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Color</label>
                    <input type="color" id="category-color" name="color" value="#3B82F6"
                           class="mt-1 block w-14 h-14 rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary dark:focus:border-primary-dark dark:focus:ring-primary-dark">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-lighter border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-dark-lightest focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary dark:bg-primary-dark border border-transparent rounded-md shadow-sm hover:bg-primary-dark dark:hover:bg-primary-darker focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-primary-dark">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Category management functions
async function fetchCategories() {
    try {
        const response = await fetch('/api/v1/categories/');
        if (!response.ok) throw new Error('Failed to fetch categories');
        const categories = await response.json();
        
        const select = document.getElementById('category_id');
        select.innerHTML = '<option value="">No Category</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            option.style.color = category.color;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching categories:', error);
    }
}

function openModal() {
    document.getElementById('category-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('category-modal').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
    // Load categories
    fetchCategories();

    // Set default date to today in local timezone
    const today = new Date();
    const localDate = today.toLocaleDateString('en-CA'); // YYYY-MM-DD format
    document.getElementById('target_date').value = localDate;
    
    // Set default time to 12:00 (noon) local time
    document.getElementById('target_time').value = '12:00';

    // Handle recurring event checkbox
    const isRecurringCheckbox = document.getElementById('is_recurring');
    const recurrenceOptions = document.getElementById('recurrence_options');
    
    isRecurringCheckbox.addEventListener('change', (e) => {
        recurrenceOptions.classList.toggle('hidden', !e.target.checked);
    });

    // Handle new category button
    document.getElementById('new-category-btn').addEventListener('click', openModal);

    // Handle category form submission
    document.getElementById('category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name'),
            color: formData.get('color')
        };
        
        try {
            const response = await fetch('/api/v1/categories/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to create category');
            }
            
            await fetchCategories();
            closeModal();
            e.target.reset();
        } catch (error) {
            console.error('Error creating category:', error);
            alert('Failed to create category: ' + error.message);
        }
    });
});

// Handle event form submission
document.getElementById('event-form').addEventListener('submit', async (e) => {
    e.preventDefault()
    
    const formData = new FormData(e.target)
    const date = formData.get('target_date');
    const time = formData.get('target_time') || '12:00';
    const target_date = timezoneUtils.localToUTC(date, time);
    
    const isRecurring = formData.get('is_recurring') === 'on';
    const data = {
        title: formData.get('title'),
        description: formData.get('description'),
        target_date: target_date,
        is_recurring: isRecurring,
        recurrence_pattern: isRecurring ? formData.get('recurrence_pattern') : null,
        category_id: formData.get('category_id') || null
    }
    
    try {
        const response = await fetch('/api/v1/events/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        
        if (!response.ok) {
            const errorData = await response.json()
            throw new Error(errorData.detail || 'Failed to create event')
        }
        
        window.location.href = '/'
    } catch (error) {
        console.error('Error creating event:', error)
        alert('Failed to create event: ' + error.message)
    }
})
</script>
{% endblock %}
