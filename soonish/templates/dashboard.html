{% extends "base.html" %}

{% block content %}
<div class="bg-white dark:bg-dark shadow overflow-hidden sm:rounded-lg" x-data="eventsData()">
    <!-- Modal Backdrop -->
    <div x-show="selectedEvent !== null"
         x-transition:enter="transition-opacity ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-80 z-40"
         @click="selectedEvent = null"></div>

    <!-- Event Modal -->
    <div x-show="selectedEvent !== null"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95 translate-y-4"
         x-transition:enter-end="opacity-100 transform scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100 translate-y-0"
         x-transition:leave-end="opacity-0 transform scale-95 translate-y-4"
         class="fixed inset-0 z-50 overflow-y-auto"
         @click.away="selectedEvent = null">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 dark:border-dark-lighter">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-semibold text-gray-900 dark:text-gray-100" x-text="selectedEvent?.title"></h3>
                        <button @click="selectedEvent = null" class="text-gray-400 dark:text-gray-500 hover:text-gray-500 dark:hover:text-gray-400">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <!-- Countdown -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Time Remaining:</span>
                            <span class="countdown font-mono text-xl font-bold text-primary dark:text-primary-dark" 
                                  x-text="getCountdown(selectedEvent?.target_date)"></span>
                        </div>

                        <!-- Description -->
                        <div class="space-y-2">
                            <h4 class="font-medium text-gray-900 dark:text-gray-100">Description</h4>
                            <p class="text-gray-600 dark:text-gray-400" x-text="selectedEvent?.description || 'No description provided.'"></p>
                        </div>

                        <!-- Date Details -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium text-gray-900 dark:text-gray-100">Target Date</h4>
                                <p class="text-gray-600 dark:text-gray-400" x-text="formatDate(selectedEvent?.target_date)"></p>
                            </div>
                            <div x-show="selectedEvent?.notify_before">
                                <h4 class="font-medium text-gray-900 dark:text-gray-100">Notification</h4>
                                <p class="text-gray-600 dark:text-gray-400" x-text="selectedEvent?.notify_before + ' minutes before'"></p>
                            </div>
                        </div>

                        <!-- Recurrence -->
                        <div x-show="selectedEvent?.is_recurring">
                            <h4 class="font-medium text-gray-900 dark:text-gray-100">Recurrence</h4>
                            <p class="text-gray-600 dark:text-gray-400" x-text="'Repeats ' + selectedEvent?.recurrence_pattern"></p>
                        </div>

                        <!-- Metadata -->
                        <div class="text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-dark-lighter pt-4 mt-4">
                            <div>Created: <span x-text="formatDate(selectedEvent?.created_at)"></span></div>
                            <div>Last Updated: <span x-text="formatDate(selectedEvent?.updated_at)"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-dark border-t border-gray-200 dark:border-dark-lighter">
                    <div class="flex justify-end space-x-3">
                        <button @click="editEvent(selectedEvent?.id)"
                                class="btn-primary">
                            Edit Event
                        </button>
                        <button @click="deleteEvent(selectedEvent?.id)"
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 dark:bg-red-700/80 dark:hover:bg-red-800/90 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:ring-offset-dark">
                            Delete Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 py-5 sm:px-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Your Upcoming Events</h1>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Keep track of what's coming up next.</p>
    </div>

    <!-- Search and Filter Controls -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-dark-lighter">
        <div class="flex flex-col sm:flex-row gap-4">
            <!-- Search -->
            <div class="flex-1">
                <label for="search" class="sr-only">Search events</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input type="text" 
                           id="search" 
                           x-model="searchQuery"
                           class="input block w-full pl-10" 
                           placeholder="Search events...">
                </div>
            </div>

            <!-- Sort -->
            <div class="sm:w-48">
                <label for="sort" class="sr-only">Sort events</label>
                <select id="sort" 
                        x-model="sortBy"
                        class="select block w-full">
                    <option value="date-asc">Date (Nearest)</option>
                    <option value="date-desc">Date (Furthest)</option>
                    <option value="title-asc">Title (A-Z)</option>
                    <option value="title-desc">Title (Z-A)</option>
                </select>
            </div>

            <!-- Filter -->
            <div class="sm:w-48">
                <label for="filter" class="sr-only">Filter events</label>
                <select id="filter" 
                        x-model="filterBy"
                        class="select block w-full">
                    <option value="all">All Events</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="past">Past</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Event Grid -->
    <div id="events-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
        <template x-if="loading">
            <div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">Loading events...</div>
        </template>
        
        <template x-if="!loading && filteredEvents.length === 0">
            <div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">
                <template x-if="searchQuery">
                    No events found matching your search.
                </template>
                <template x-if="!searchQuery">
                    No events yet. Click "New Event" to create one!
                </template>
            </div>
        </template>

        <template x-for="event in filteredEvents" :key="event.id">
            <div class="card hover:shadow-lg transition-all duration-200"
                 :class="{ 'ring-2 ring-primary dark:ring-primary-dark': selectedEvent?.id === event.id }"
                 :data-event-id="event.id"
                 @click="selectedEvent = event">
                
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-primary-dark transition-colors" x-text="event.title"></h3>
                        <span class="countdown font-mono text-xl text-primary dark:text-primary-dark" x-text="getCountdown(event.target_date)"></span>
                    </div>
                    
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 line-clamp-2" 
                       x-text="event.description || 'No description'"></p>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400" x-text="formatDate(event.target_date)"></span>
                        
                        <!-- Event Indicators -->
                        <div class="flex space-x-2">
                            <span x-show="event.is_recurring" 
                                  class="text-primary dark:text-primary-dark" 
                                  title="Recurring Event">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </span>
                            <span x-show="event.notify_before" 
                                  class="text-primary dark:text-primary-dark"
                                  title="Has Notification">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function eventsData() {
    return {
        events: [],
        loading: true,
        searchQuery: '',
        sortBy: 'date-asc',
        filterBy: 'all',
        selectedEvent: null,
        
        async init() {
            await this.fetchEvents()
            this.startCountdownUpdates()
        },
        
        async fetchEvents() {
            try {
                const response = await fetch('/api/v1/events')
                if (!response.ok) throw new Error('Failed to fetch events')
                this.events = await response.json()
            } catch (error) {
                console.error('Error fetching events:', error)
            } finally {
                this.loading = false
            }
        },
        
        startCountdownUpdates() {
            setInterval(() => {
                // Force Alpine to update countdowns
                this.events = [...this.events]
            }, 1000)
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        },
        
        getCountdown(targetDate) {
            const now = new Date()
            const target = new Date(targetDate)
            const diff = target - now
            
            if (diff < 0) return 'Past'
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24))
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))
            
            if (days > 0) return `${days}d ${hours}h`
            if (hours > 0) return `${hours}h ${minutes}m`
            return `${minutes}m`
        },
        
        async deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return
            
            try {
                const response = await fetch(`/api/v1/events/${eventId}`, {
                    method: 'DELETE'
                })
                if (!response.ok) throw new Error('Failed to delete event')
                this.events = this.events.filter(e => e.id !== eventId)
                this.selectedEvent = null
            } catch (error) {
                console.error('Error deleting event:', error)
                alert('Failed to delete event')
            }
        },
        
        editEvent(eventId) {
            window.location.href = `/events/${eventId}/edit`
        },
        
        get filteredEvents() {
            let filtered = [...this.events]
            
            // Apply search filter
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase()
                filtered = filtered.filter(event => 
                    event.title.toLowerCase().includes(query) ||
                    (event.description && event.description.toLowerCase().includes(query))
                )
            }
            
            // Apply time filter
            const now = new Date()
            switch (this.filterBy) {
                case 'upcoming':
                    filtered = filtered.filter(event => new Date(event.target_date) > now)
                    break
                case 'past':
                    filtered = filtered.filter(event => new Date(event.target_date) < now)
                    break
                case 'today':
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.target_date)
                        return eventDate.toDateString() === now.toDateString()
                    })
                    break
                case 'week':
                    const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000)
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.target_date)
                        return eventDate > now && eventDate <= weekFromNow
                    })
                    break
                case 'month':
                    const monthFromNow = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate())
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.target_date)
                        return eventDate > now && eventDate <= monthFromNow
                    })
                    break
            }
            
            // Apply sort
            filtered.sort((a, b) => {
                switch (this.sortBy) {
                    case 'date-asc':
                        return new Date(a.target_date) - new Date(b.target_date)
                    case 'date-desc':
                        return new Date(b.target_date) - new Date(a.target_date)
                    case 'title-asc':
                        return a.title.localeCompare(b.title)
                    case 'title-desc':
                        return b.title.localeCompare(a.title)
                    default:
                        return 0
                }
            })
            
            return filtered
        }
    }
}
</script>
{% endblock %}