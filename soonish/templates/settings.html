{% extends "base.html" %}

{% block title %}Settings - Soonish{% endblock %}

{% block content %}
<div class="space-y-8" x-data="settingsData()">
    <div class="bg-white dark:bg-dark shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Categories</h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage your event categories.</p>
        </div>
        
        <div class="border-t border-gray-200 dark:border-dark-lighter px-4 py-5 sm:p-6">
            <!-- Add Category Form -->
            <form @submit.prevent="addCategory" class="mb-6 p-4 bg-gray-50 dark:bg-dark-lighter rounded-lg">
                <div class="space-y-4">
                    <div>
                        <label for="categoryName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Category Name
                        </label>
                        <input type="text"
                               id="categoryName"
                               x-model="newCategory.name"
                               required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-dark-input dark:border-gray-600 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="categoryColor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Category Color
                        </label>
                        <div class="mt-1 flex items-center space-x-2">
                            <input type="color"
                                   id="categoryColor"
                                   x-model="newCategory.color"
                                   class="h-8 w-16 p-0 rounded border border-gray-300 dark:border-gray-600">
                            <span class="text-sm text-gray-500 dark:text-gray-400" x-text="newCategory.color"></span>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit"
                                class="btn-primary">
                            Add Category
                        </button>
                    </div>
                </div>
            </form>

            <!-- Categories List -->
            <div class="space-y-4">
                <template x-for="category in categories" :key="category.id">
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 dark:border-dark-lighter last:border-0">
                        <div class="flex items-center space-x-3">
                            <span class="w-4 h-4 rounded-full" :style="{ backgroundColor: category.color }"></span>
                            <span class="text-gray-900 dark:text-gray-100" x-text="category.name"></span>
                        </div>
                        <button @click="deleteCategory(category.id)"
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 focus:outline-none">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function settingsData() {
    return {
        categories: [],
        newCategory: {
            name: '',
            color: '#3B82F6' // Default to a blue color
        },
        
        async init() {
            await this.fetchCategories()
        },

        async addCategory() {
            try {
                const response = await fetch('/api/v1/categories/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.newCategory)
                })

                if (!response.ok) throw new Error('Failed to create category')
                
                // Add the new category to the list
                const category = await response.json()
                this.categories.push(category)
                
                // Reset the form
                this.newCategory = {
                    name: '',
                    color: '#3B82F6'
                }
            } catch (error) {
                console.error('Error creating category:', error)
                alert('Failed to create category')
            }
        },

        async fetchCategories() {
            try {
                const response = await fetch('/api/v1/categories/')
                if (!response.ok) throw new Error('Failed to fetch categories')
                this.categories = await response.json()
            } catch (error) {
                console.error('Error fetching categories:', error)
            }
        },

        async deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category? Any events using this category will have their category removed.')) {
                return
            }

            try {
                const response = await fetch(`/api/v1/categories/${categoryId}`, {
                    method: 'DELETE'
                })
                if (!response.ok) throw new Error('Failed to delete category')
                
                // Remove the category from the list
                this.categories = this.categories.filter(c => c.id !== categoryId)
            } catch (error) {
                console.error('Error deleting category:', error)
                alert('Failed to delete category')
            }
        }
    }
}
</script>
{% endblock %}